<!DOCTYPE html><html><head><title>Keeping Water Out of a Boat | Jeff Hube</title><meta name=viewport content="width=device-width"><link rel=alternate type=application/rss+xml title="Jeff Hube &raquo; Feed" href=/blog/feed.xml><link rel=icon type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/stylesheets/style.css?1499403666><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300" rel=stylesheet type=text/css></head><body><div class=rows><div class=row><div class=header><div class=container><label for=hamburger class=hamburger-label></label><a class=title href=/ >Jeff Hube</a></div></div><input type=checkbox id=hamburger class=hamburger-input checked><div class=nav><div class="container container-collapse"><a href=/games/ >Games</a><a href=/demos/ >Demos</a><a href=/resume/ >Resume</a><a href=/ class=active>Blog</a></div></div></div><div class="row row-expand"><div class=content><div class="container clearfix"><div class=columns><div class=column-right><div><h1>Keeping Water Out of a Boat</h1><span class=post-date>July 07, 2017</span><p>Here is a long overdue post I wanted to make about the game I worked on for <a href=http://globalgamejam.org/ >Global Game Jam</a> 2017, <a href=http://globalgamejam.org/2017/games/wrath-poseidon-0>Wrath of Poseidon</a>. When we first placed the boat in the water, the water plane clipped right though it, as seen below. This results in a pretty sad looking boat, so we needed to find a way to make sure the water is only drawn around the boat.</p><p><a href=/images/posts/boatwaterocclusion1.png><img class=post-image src=/images/posts/boatwaterocclusion1.png alt="water clipping through boat"></a></p><p>The solution I thought of was to create a &quot;cover&quot; over the boat, above the water level. The cover would be fully transparent, but still be drawn to the depth buffer. First the boat would be drawn, then the cover, and lastly the water. When the water was drawn it would fail the depth test in the areas under the cover, leaving the inside of the boat dry.</p><h3 id=the-cover-mesh>The cover mesh</h3><p>Here we have the cover mesh, without the transparent material applied. Note that the cover is flat instead of following the top surface of the boat. This avoids an issue where otherwise, from certain camera angles, the cover could obscure water that is outside of the boat.</p><p><a href=/images/posts/boatwaterocclusion2.png><img class=post-image src=/images/posts/boatwaterocclusion2.png alt="cover without material"></a></p><h3 id=transparent-shader-for-the-cover>Transparent shader for the cover</h3><p>Here is the code for the shader, which has three parts of interest. The first is <code>&quot;Queue&quot;=&quot;Geometry+1&quot;</code>, which causes the cover to be drawn after other geometry; we would end up with a hole in the boat if the cover is drawn first. The second is <code>Blend SrcAlpha OneMinusSrcAlpha</code>, which enables alpha blending, and the third is <code>return fixed4(0, 0, 0, 0);</code>, which uses a fully transparent color for the cover.</p><pre><code class=hljs>Shader <span class=hljs-string>"Custom/BoatWaterOcclude"</span>
{
    <span class=hljs-keyword>SubShader</span>
    {
        Tags { <span class=hljs-string>"RenderType"</span>=<span class=hljs-string>"Opaque"</span> <span class=hljs-string>"Queue"</span>=<span class=hljs-string>"Geometry+1"</span> }
        <span class=hljs-keyword>LOD</span> 100
        Blend SrcAlpha OneMinusSrcAlpha

        <span class=hljs-keyword>Pass</span>
        {
            CGPROGRAM
            <span class=hljs-comment>#pragma vertex vert</span>
            <span class=hljs-comment>#pragma fragment frag</span>

            <span class=hljs-comment>#include "UnityCG.cginc"</span>

            struct appdata
            {
                float4 vertex : POSITION;
            };

            float4 vert (appdata v) : <span class=hljs-keyword>SV_POSITION</span>
            {
                return UnityObjectToClipPos(v.vertex);
            }

            <span class=hljs-keyword>fixed4</span> <span class=hljs-keyword>frag</span> () : <span class=hljs-keyword>SV_Target</span>
            {
                return fixed4(<span class=hljs-number>0</span>, <span class=hljs-number>0</span>, <span class=hljs-number>0</span>, <span class=hljs-number>0</span>);
            }
            <span class=hljs-keyword>ENDCG</span>
        }
    }
}</code></pre><h3 id=draw-the-water-after-the-cover>Draw the water after the cover</h3><p>The last step is to ensure the water is drawn after the cover. Since the cover shader uses <code>Geometry+1</code> for the queue, we will just use <code>Geometry+2</code> in the water shader. The rest of the water shader has been omitted since it is not relevant.</p><pre><code class=hljs><span class=hljs-class>Tags </span>{ <span class=hljs-string>"RenderType"</span>=<span class=hljs-string>"Opaque"</span> <span class=hljs-string>"Queue"</span>=<span class=hljs-string>"Geometry+2"</span> }</code></pre><h3 id=results>Results</h3><p>Here is the finished product. The boat is now seaworthy!</p><p><a href=/images/posts/boatwaterocclusion3.png><img class=post-image src=/images/posts/boatwaterocclusion3.png alt="finished result"></a></p><p>Cheers,</p><p>Jeff</p><div class=tags><a class=tag href=/blog/tags/unity3d/ >Unity3D</a></div><div class=next-prev><span class=next-prev-secondary>Previous Post</span> <a href=/blog/2016/07/fixing-metadata-wsdl/ >Fixing metadata.wsdl</a></div><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.identifier='/blog/2017/07/keeping-water-out-of-a-boat/';this.page.title='Keeping Water Out of a Boat';this.page.url='https://www.jeffhube.com'+location.pathname;};(function(){var d=document,s=d.createElement('script');s.src='//jeffhube.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script></div></div><div class=column-left><h3>Recent Posts</h3><div class=recent-post><a href=/blog/2017/07/keeping-water-out-of-a-boat/ >Keeping Water Out of a Boat</a> <span class=recent-post-date>July 07, 2017</span></div><div class=recent-post><a href=/blog/2016/07/fixing-metadata-wsdl/ >Fixing metadata.wsdl</a> <span class=recent-post-date>July 05, 2016</span></div><div class=recent-post><a href=/blog/2016/05/salesforce-globals-and-breaking-changes-part-2/ >Salesforce: Globals and Breaking Changes, Part 2</a> <span class=recent-post-date>May 10, 2016</span></div><div class=recent-post><a href=/blog/2016/04/salesforce-globals-and-breaking-changes-part-1/ >Salesforce: Globals and Breaking Changes, Part 1</a> <span class=recent-post-date>April 27, 2016</span></div><div class=recent-post><a href=/blog/2016/04/welcome/ >Welcome!</a> <span class=recent-post-date>April 25, 2016</span></div><h3>Tags</h3><div class=popular-tag><a href=/blog/tags/salesforce/ >Salesforce</a> <span class=tag-count>(3)</span></div><div class=popular-tag><a href=/blog/tags/unity3d/ >Unity3D</a> <span class=tag-count>(1)</span></div><div class=popular-tag><a href=/blog/tags/welcome/ >Welcome</a> <span class=tag-count>(1)</span></div></div></div></div></div></div><div class=row><div class=footer><div class=container><div class=social><a href=http://www.youtube.com/user/jrh2365/videos><img src=/images/social/32_youtube.png width=32 height=32 alt=YouTube></a><a href=http://www.linkedin.com/in/jeffhube><img src=/images/social/32_linkedin.png width=32 height=32 alt=LinkedIn></a></div><div class=copyright>Copyright &copy; Jeff Hube 2016</div></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-20753646-2','auto');ga('send','pageview');</script></body></html>